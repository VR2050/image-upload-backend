<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂõæÁâá‰∏ä‰º†ÁÆ°ÁêÜÁ≥ªÁªü</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow: hidden;
            will-change: transform;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.4rem;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .header .stats {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            font-size: 0.8rem;
        }
        
        .main-content {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            min-height: 500px;
        }
        
        @media (min-width: 768px) {
            .main-content {
                grid-template-columns: 280px 1fr;
                padding: 20px;
                gap: 20px;
            }
            
            .header {
                padding: 25px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
        
        .sidebar {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            order: 2;
        }
        
        @media (min-width: 768px) {
            .sidebar {
                order: 1;
            }
        }
        
        .module-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .module-item {
            padding: 12px;
            margin: 6px 0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            touch-action: manipulation;
        }
        
        .module-item:active {
            transform: scale(0.98);
            background: #e3f2ff;
        }
        
        .module-item.active {
            background: #4facfe;
            color: white;
        }
        
        .module-info {
            flex: 1;
        }
        
        .module-name {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .module-count {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 2px;
        }
        
        .module-delete {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            min-width: 24px;
            min-height: 24px;
        }
        
        .add-module {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .add-module input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            outline: none;
            font-size: 14px;
            background: white;
        }
        
        .add-module input:focus {
            border-color: #4facfe;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: #4facfe;
            color: white;
        }
        
        .btn-success {
            background: #2ed573;
            color: white;
        }
        
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        
        .content-area {
            background: white;
            border-radius: 10px;
            padding: 0;
            order: 1;
        }
        
        @media (min-width: 768px) {
            .content-area {
                order: 2;
            }
        }
        
        .upload-section {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .upload-area {
            border: 2px dashed #4facfe;
            border-radius: 12px;
            padding: 25px 15px;
            text-align: center;
            background: #f8faff;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }
        
        .upload-area:active {
            background: #e3f2ff;
            transform: scale(0.98);
        }
        
        .upload-icon {
            font-size: 32px;
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .upload-text {
            margin-bottom: 15px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .upload-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        @media (min-width: 480px) {
            .upload-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        .upload-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            min-width: 120px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .upload-btn:active {
            transform: scale(0.95);
        }
        
        .upload-btn.camera {
            background: #ff9f43;
        }
        
        .upload-btn.gallery {
            background: #2ed573;
        }
        
        .file-input {
            display: none;
        }
        
        .images-section {
            padding: 15px;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }
        
        @media (max-width: 480px) {
            .images-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
        }
        
        @media (min-width: 768px) {
            .images-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
        }
        
        .image-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
            background: white;
            aspect-ratio: 1;
        }
        
        .image-card:active {
            transform: scale(0.95);
        }
        
        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #f8f9fa;
            transition: opacity 0.3s ease;
        }
        
        .image-preview.loading {
            opacity: 0.5;
        }
        
        .image-info {
            display: none; /* ÈöêËóèËØ¶ÁªÜ‰ø°ÊÅØÔºåÂè™ÊòæÁ§∫Áº©Áï•Âõæ */
        }
        
        .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            padding: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .image-card:hover .image-actions {
            opacity: 1;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 0.7rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.9);
            color: #333;
            min-height: 24px;
        }
        
        .btn-small:active {
            transform: scale(0.95);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #ffeaea;
            color: #ff4757;
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            border: 1px solid #ffcccc;
            font-size: 0.85rem;
        }
        
        .success {
            background: #eaffea;
            color: #2ed573;
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            border: 1px solid #ccffcc;
            font-size: 0.85rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.3s ease;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #666;
        }
        
        .empty-icon {
            font-size: 36px;
            color: #ddd;
            margin-bottom: 10px;
        }
        
        /* Áõ∏Êú∫Ê®°ÊÄÅÊ°Ü‰ºòÂåñ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 10px;
        }
        
        .camera-container {
            width: 100%;
            max-width: 400px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .camera-preview {
            width: 100%;
            height: 60vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* ÈïúÂÉèÁøªËΩ¨ÔºåÊõ¥Ëá™ÁÑ∂ */
        }
        
        .camera-controls {
            padding: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            background: rgba(0,0,0,0.8);
        }
        
        .camera-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            min-height: 44px;
            min-width: 80px;
            font-weight: 600;
        }
        
        .capture-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: 4px solid #4facfe;
            cursor: pointer;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* ÂõæÁâáÊü•Áúã‰ºòÂåñ */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 10px;
        }
        
        .image-viewer img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        /* ÊÄßËÉΩ‰ºòÂåñÁ±ª */
        .will-change {
            will-change: transform, opacity;
        }
        
        .image-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            animation: placeholder-shimmer 2s infinite linear;
        }
        
        @keyframes placeholder-shimmer {
            0% { background-position: -100px 0; }
            100% { background-position: 100px 0; }
        }
        
        /* ËôöÊãüÊªöÂä®ÂÆπÂô® */
        .virtual-scroll {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>üì∑ ÂõæÁâá‰∏ä‰º†ÁÆ°ÁêÜÁ≥ªÁªü</h1>
                <p>È´òÊÄßËÉΩÁº©Áï•ÂõæÂ±ïÁ§∫</p>
                <div class="stats">
                    <div class="stat-item">Ê®°Âùó: {{ stats.total_modules || 0 }}</div>
                    <div class="stat-item">ÂõæÁâá: {{ stats.total_images || 0 }}</div>
                    <div class="stat-item">Â§ßÂ∞è: {{ stats.total_size_mb || 0 }} MB</div>
                </div>
            </div>
            
            <div class="main-content">
                <!-- ÂÜÖÂÆπÂå∫Âüü -->
                <div class="content-area">
                    <!-- ‰∏ä‰º†Âå∫Âüü -->
                    <div class="upload-section">
                        <div 
                            class="upload-area"
                            @click="triggerFileInput"
                        >
                            <div class="upload-icon">üìÅ</div>
                            <div class="upload-text">
                                <div>ÈÄâÊã©ÂõæÁâá‰∏ä‰º†</div>
                                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">
                                    Ëá™Âä®ÂéãÁº©‰ºòÂåñ
                                </div>
                            </div>
                            
                            <div class="upload-buttons">
                                <button class="upload-btn gallery" @click.stop="openGallery">
                                    üì± Áõ∏ÂÜå
                                </button>
                                <button class="upload-btn camera" @click.stop="openCamera">
                                    üì∏ ÊãçÁÖß
                                </button>
                            </div>
                            
                            <input 
                                type="file" 
                                ref="fileInput"
                                class="file-input" 
                                multiple 
                                accept="image/*"
                                @change="handleFileSelect"
                            >
                            <input 
                                type="file" 
                                ref="galleryInput"
                                class="file-input" 
                                multiple 
                                accept="image/*"
                                @change="handleFileSelect"
                            >
                        </div>
                        
                        <div v-if="uploadProgress > 0" class="progress-bar">
                            <div class="progress" :style="{ width: uploadProgress + '%' }"></div>
                        </div>
                        
                        <div v-if="uploadMessage" :class="['message', uploadSuccess ? 'success' : 'error']">
                            {{ uploadMessage }}
                        </div>
                    </div>
                    
                    <!-- ÂõæÁâáÂ±ïÁ§∫Âå∫Âüü -->
                    <div class="images-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="font-size: 1rem; margin: 0;">
                                {{ currentModule }} ({{ images.length }})
                            </h3>
                            <button v-if="images.length > 0" class="btn-small" @click="clearCache" style="background: #ffa502; color: white;">
                                Âà∑Êñ∞ÁºìÂ≠ò
                            </button>
                        </div>
                        
                        <div v-if="loading" class="loading">
                            <div style="font-size: 1rem; margin-bottom: 8px;">‚è≥</div>
                            Âä†ËΩΩ‰∏≠...
                        </div>
                        
                        <div v-else-if="images.length === 0" class="empty-state">
                            <div class="empty-icon">üñºÔ∏è</div>
                            <div style="font-size: 0.9rem; margin-bottom: 6px;">ÊöÇÊó†ÂõæÁâá</div>
                        </div>
                        
                        <div v-else class="images-grid virtual-scroll" style="max-height: 60vh;">
                            <div 
                                v-for="image in visibleImages" 
                                :key="image.filename" 
                                class="image-card will-change"
                                @click="viewImage(image)"
                            >
                                <img 
                                    :src="getThumbnailUrl(image.url)" 
                                    :alt="image.filename"
                                    class="image-preview"
                                    :class="{ loading: !image.loaded }"
                                    @load="imageLoaded(image)"
                                    @error="imageError(image)"
                                    loading="lazy"
                                    decoding="async"
                                >
                                <div class="image-actions">
                                    <button 
                                        class="btn-small btn-danger"
                                        @click.stop="deleteImage(image)"
                                    >Âà†Èô§</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ‰æßËæπÊ†è -->
                <div class="sidebar">
                    <div class="add-module">
                        <input 
                            v-model="newModuleName" 
                            @keyup.enter="createModule"
                            placeholder="Êñ∞Ê®°Âùó"
                            maxlength="12"
                        >
                        <button class="btn btn-primary" @click="createModule" style="min-width: 50px; padding: 10px;">+</button>
                    </div>
                    
                    <div class="module-list">
                        <div 
                            v-for="module in modules" 
                            :key="module.name"
                            :class="['module-item', { active: currentModule === module.name }]"
                            @click="selectModule(module.name)"
                        >
                            <div class="module-info">
                                <div class="module-name">{{ module.name }}</div>
                                <div class="module-count">{{ module.image_count }} Âº†</div>
                            </div>
                            <button 
                                v-if="module.name !== 'default'" 
                                class="module-delete"
                                @click.stop="deleteModule(module.name)"
                            >√ó</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÂõæÁâáÊü•ÁúãÊ®°ÊÄÅÊ°Ü -->
        <div v-if="viewingImage" class="image-viewer" @click="viewingImage = null">
            <button class="close-btn" @click.stop="viewingImage = null">√ó</button>
            <img :src="getImageUrl(viewingImage.url)" @click.stop>
        </div>
        
        <!-- Áõ∏Êú∫Ê®°ÊÄÅÊ°Ü -->
        <div v-if="showCamera" class="modal-overlay">
            <div class="camera-container">
                <div class="camera-preview">
                    <video ref="video" autoplay playsinline></video>
                </div>
                <div class="capture-btn" @click="takePhoto"></div>
                <div class="camera-controls">
                    <button class="camera-btn btn-danger" @click="closeCamera">ÂèñÊ∂à</button>
                </div>
            </div>
            <canvas ref="canvas" style="display: none;"></canvas>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    modules: [],
                    currentModule: 'default',
                    newModuleName: '',
                    images: [],
                    visibleImages: [],
                    loading: false,
                    uploadProgress: 0,
                    uploadMessage: '',
                    uploadSuccess: false,
                    viewingImage: null,
                    showCamera: false,
                    stats: {},
                    stream: null,
                    imageCache: new Map(),
                    scrollTop: 0
                }
            },
            
            async mounted() {
                await this.loadModules();
                await this.loadStats();
                if (this.modules.length > 0) {
                    this.currentModule = this.modules[0].name;
                    await this.loadImages();
                }
                
                this.setupPerformance();
            },
            
            methods: {
                // ÊÄßËÉΩ‰ºòÂåñËÆæÁΩÆ
                setupPerformance() {
                    // ‰ΩøÁî® Intersection Observer ÂÆûÁé∞ÊáíÂä†ËΩΩ
                    if ('IntersectionObserver' in window) {
                        this.observer = new IntersectionObserver((entries) => {
                            entries.forEach(entry => {
                                if (entry.isIntersecting) {
                                    const img = entry.target;
                                    const src = img.getAttribute('data-src');
                                    if (src) {
                                        img.src = src;
                                        img.removeAttribute('data-src');
                                    }
                                    this.observer.unobserve(img);
                                }
                            });
                        }, {
                            rootMargin: '50px 0px',
                            threshold: 0.1
                        });
                    }
                    
                    // Èò≤ÊäñÊªöÂä®Â§ÑÁêÜ
                    this.handleScroll = this.debounce(() => {
                        this.updateVisibleImages();
                    }, 50);
                    
                    window.addEventListener('scroll', this.handleScroll, { passive: true });
                },
                
                // Èò≤ÊäñÂáΩÊï∞
                debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                },
                
                // Êõ¥Êñ∞ÂèØËßÅÂõæÁâáÔºàËôöÊãüÊªöÂä®Ôºâ
                updateVisibleImages() {
                    // ÁÆÄÂçïÁöÑËôöÊãüÊªöÂä®ÂÆûÁé∞
                    const startIndex = 0;
                    const endIndex = Math.min(startIndex + 50, this.images.length);
                    this.visibleImages = this.images.slice(startIndex, endIndex);
                },
                
                // API Âü∫Á°ÄÊñπÊ≥ï
                async apiCall(url, options = {}) {
                    try {
                        const baseUrl = window.location.origin;
                        const response = await fetch(`${baseUrl}/api${url}`, {
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });
                        
                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error('APIË∞ÉÁî®Â§±Ë¥•:', error);
                        throw error;
                    }
                },
                
                // Âä†ËΩΩÊ®°ÂùóÂàóË°®
                async loadModules() {
                    try {
                        const data = await this.apiCall('/modules');
                        if (data.success) {
                            this.modules = data.data;
                        }
                    } catch (error) {
                        this.showError('Âä†ËΩΩÊ®°ÂùóÂ§±Ë¥•');
                    }
                },
                
                // Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØ
                async loadStats() {
                    try {
                        const data = await this.apiCall('/stats');
                        if (data.success) {
                            this.stats = data.data;
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩÁªüËÆ°Â§±Ë¥•:', error);
                    }
                },
                
                // ÂàõÂª∫Ê®°Âùó
                async createModule() {
                    if (!this.newModuleName.trim()) {
                        this.showError('ËØ∑ËæìÂÖ•Ê®°ÂùóÂêçÁß∞');
                        return;
                    }
                    
                    try {
                        const data = await this.apiCall('/modules', {
                            method: 'POST',
                            body: JSON.stringify({ name: this.newModuleName.trim() })
                        });
                        
                        if (data.success) {
                            this.newModuleName = '';
                            await this.loadModules();
                            await this.loadStats();
                            this.showSuccess('Ê®°ÂùóÂàõÂª∫ÊàêÂäü');
                        } else {
                            this.showError(data.message);
                        }
                    } catch (error) {
                        this.showError('ÂàõÂª∫Ê®°ÂùóÂ§±Ë¥•');
                    }
                },
                
                // Âà†Èô§Ê®°Âùó
                async deleteModule(moduleName) {
                    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ê®°Âùó "${moduleName}" ÂêóÔºü`)) {
                        return;
                    }
                    
                    try {
                        const data = await this.apiCall(`/modules/${moduleName}`, {
                            method: 'DELETE'
                        });
                        
                        if (data.success) {
                            await this.loadModules();
                            await this.loadStats();
                            if (this.currentModule === moduleName) {
                                this.currentModule = this.modules[0]?.name || '';
                                await this.loadImages();
                            }
                            this.showSuccess('Ê®°ÂùóÂà†Èô§ÊàêÂäü');
                        } else {
                            this.showError(data.message);
                        }
                    } catch (error) {
                        this.showError('Âà†Èô§Ê®°ÂùóÂ§±Ë¥•');
                    }
                },
                
                // ÈÄâÊã©Ê®°Âùó
                async selectModule(moduleName) {
                    this.currentModule = moduleName;
                    await this.loadImages();
                },
                
                // Âä†ËΩΩÂõæÁâáÂàóË°®
                async loadImages() {
                    if (!this.currentModule) return;
                    
                    this.loading = true;
                    try {
                        const data = await this.apiCall(`/images/${this.currentModule}`);
                        if (data.success) {
                            // Ê†áËÆ∞ÂõæÁâáÂä†ËΩΩÁä∂ÊÄÅ
                            this.images = data.data.map(img => ({
                                ...img,
                                loaded: false
                            }));
                            this.updateVisibleImages();
                        } else {
                            this.showError(data.message);
                        }
                    } catch (error) {
                        this.showError('Âä†ËΩΩÂõæÁâáÂ§±Ë¥•');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
                triggerFileInput() {
                    this.$refs.fileInput.click();
                },
                
                // ÊâìÂºÄÁõ∏ÂÜåÈÄâÊã©
                openGallery() {
                    this.$refs.galleryInput.click();
                },
                
                // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
                async handleFileSelect(event) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        await this.uploadFiles(files);
                    }
                    event.target.value = '';
                },
                
                // ‰∏ä‰º†Êñá‰ª∂Ôºà‰ºòÂåñÁâàÔºâ
                async uploadFiles(files) {
                    if (!this.currentModule) {
                        this.showError('ËØ∑ÂÖàÈÄâÊã©Ê®°Âùó');
                        return;
                    }
                    
                    this.uploadProgress = 0;
                    this.uploadMessage = '';
                    
                    const formData = new FormData();
                    let validFiles = 0;
                    
                    // ‰ΩøÁî® Promise.all Âπ∂Ë°åÂ§ÑÁêÜÊñá‰ª∂ÂéãÁº©
                    const processPromises = Array.from(files).map(async (file) => {
                        if (!file.type.startsWith('image/')) {
                            this.showError(`Êñá‰ª∂ "${file.name}" ‰∏çÊòØÂõæÁâáÊ†ºÂºè`);
                            return null;
                        }
                        
                        // Âø´ÈÄüÂéãÁº©ÔºöÂè™ÂéãÁº©Â§ßÊñá‰ª∂
                        if (file.size > 2 * 1024 * 1024) {
                            try {
                                return await this.quickCompressImage(file);
                            } catch (error) {
                                console.warn('ÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÊñá‰ª∂:', error);
                                return file;
                            }
                        }
                        return file;
                    });
                    
                    const processedFiles = await Promise.all(processPromises);
                    
                    processedFiles.forEach(file => {
                        if (file) {
                            formData.append('files', file);
                            validFiles++;
                        }
                    });
                    
                    if (validFiles === 0) {
                        this.showError('Ê≤°ÊúâÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂');
                        return;
                    }
                    
                    this.uploadWithProgress(formData, validFiles);
                },
                
                // Âø´ÈÄüÂõæÁâáÂéãÁº©
                quickCompressImage(file) {
                    return new Promise((resolve) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        
                        img.onload = () => {
                            // Âø´ÈÄüÂéãÁº©ÔºöÂõ∫ÂÆöÁº©ÊîæÂà∞ 1200px
                            const maxSize = 1200;
                            let { width, height } = img;
                            
                            if (width > height && width > maxSize) {
                                height = (height * maxSize) / width;
                                width = maxSize;
                            } else if (height > maxSize) {
                                width = (width * maxSize) / height;
                                height = maxSize;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            canvas.toBlob((blob) => {
                                resolve(new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                }));
                            }, 'image/jpeg', 0.7); // ËæÉ‰ΩéË¥®ÈáèÔºåÊõ¥Âø´ÂéãÁº©
                        };
                        
                        img.src = URL.createObjectURL(file);
                    });
                },
                
                // Â∏¶ËøõÂ∫¶Êù°ÁöÑ‰∏ä‰º†
                uploadWithProgress(formData, fileCount) {
                    const baseUrl = window.location.origin;
                    const xhr = new XMLHttpRequest();
                    
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            this.uploadProgress = (e.loaded / e.total) * 100;
                        }
                    });
                    
                    xhr.addEventListener('load', async () => {
                        if (xhr.status === 200) {
                            const data = JSON.parse(xhr.responseText);
                            if (data.success) {
                                this.uploadSuccess = true;
                                this.uploadMessage = `ÊàêÂäü‰∏ä‰º† ${fileCount} Âº†ÂõæÁâá`;
                                await this.loadImages();
                                await this.loadStats();
                                setTimeout(() => {
                                    this.uploadProgress = 0;
                                    this.uploadMessage = '';
                                }, 2000);
                            } else {
                                this.showError(data.message);
                            }
                        } else {
                            this.showError('‰∏ä‰º†Â§±Ë¥•');
                        }
                    });
                    
                    xhr.addEventListener('error', () => {
                        this.showError('ÁΩëÁªúÈîôËØØ');
                    });
                    
                    xhr.open('POST', `${baseUrl}/api/upload?module=${this.currentModule}`);
                    xhr.send(formData);
                },
                
                // ÊâìÂºÄÁõ∏Êú∫Ôºà‰ºòÂåñÁâàÔºâ
                async openCamera() {
                    if (!this.currentModule) {
                        this.showError('ËØ∑ÂÖàÈÄâÊã©Ê®°Âùó');
                        return;
                    }
                    
                    try {
                        // ‰ΩøÁî®ËæÉ‰ΩéÁöÑÂàÜËæ®ÁéáÊèêÈ´òÊÄßËÉΩ
                        this.stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: 'environment',
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            } 
                        });
                        this.showCamera = true;
                        this.$nextTick(() => {
                            this.$refs.video.srcObject = this.stream;
                        });
                    } catch (error) {
                        this.showError('Êó†Ê≥ïËÆøÈóÆÁõ∏Êú∫');
                    }
                },
                
                // ÂÖ≥Èó≠Áõ∏Êú∫
                closeCamera() {
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                        this.stream = null;
                    }
                    this.showCamera = false;
                },
                
                // ÊãçÁÖßÔºà‰ºòÂåñÁâàÔºâ
                takePhoto() {
                    const video = this.$refs.video;
                    const canvas = this.$refs.canvas;
                    const context = canvas.getContext('2d');
                    
                    // ‰ΩøÁî®ËæÉ‰ΩéÂàÜËæ®ÁéáÊãçÁÖß
                    canvas.width = 1024;
                    canvas.height = 768;
                    
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], `photo_${Date.now()}.jpg`, { 
                            type: 'image/jpeg' 
                        });
                        
                        await this.uploadFiles([file]);
                        this.closeCamera();
                    }, 'image/jpeg', 0.8);
                },
                
                // Êü•ÁúãÂõæÁâá
                viewImage(image) {
                    this.viewingImage = image;
                },
                
                // Âà†Èô§ÂõæÁâá
                async deleteImage(image) {
                    if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÂõæÁâáÂêóÔºü')) {
                        return;
                    }
                    
                    try {
                        const data = await this.apiCall(`/image/${image.module}/${image.filename}`, {
                            method: 'DELETE'
                        });
                        
                        if (data.success) {
                            await this.loadImages();
                            await this.loadStats();
                            this.showSuccess('Âà†Èô§ÊàêÂäü');
                        } else {
                            this.showError(data.message);
                        }
                    } catch (error) {
                        this.showError('Âà†Èô§Â§±Ë¥•');
                    }
                },
                
                // Ê∏ÖÈô§ÁºìÂ≠ò
                clearCache() {
                    this.imageCache.clear();
                    this.loadImages();
                    this.showSuccess('ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§');
                },
                
                // Â∑•ÂÖ∑ÊñπÊ≥ï
                getImageUrl(url) {
                    const baseUrl = window.location.origin;
                    return url.startsWith('http') ? url : `${baseUrl}${url}`;
                },
                
                getThumbnailUrl(url) {
                    // Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Áº©Áï•ÂõæÁîüÊàêÈÄªËæë
                    // ÁõÆÂâçÁõ¥Êé•ËøîÂõûÂéüÂõæURLÔºå‰ΩÜÂª∫ËÆÆÂú®ÂêéÁ´ØÁîüÊàêÁº©Áï•Âõæ
                    return this.getImageUrl(url);
                },
                
                imageLoaded(image) {
                    image.loaded = true;
                },
                
                imageError(image) {
                    image.loaded = true;
                    // ÂèØ‰ª•ËÆæÁΩÆ‰∏Ä‰∏™ÈªòËÆ§ÁöÑÂç†‰ΩçÂõæ
                },
                
                showError(message) {
                    this.uploadSuccess = false;
                    this.uploadMessage = message;
                    setTimeout(() => {
                        this.uploadMessage = '';
                    }, 3000);
                },
                
                showSuccess(message) {
                    this.uploadSuccess = true;
                    this.uploadMessage = message;
                    setTimeout(() => {
                        this.uploadMessage = '';
                    }, 2000);
                }
            },
            
            beforeUnmount() {
                // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
                if (this.handleScroll) {
                    window.removeEventListener('scroll', this.handleScroll);
                }
                if (this.observer) {
                    this.observer.disconnect();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>